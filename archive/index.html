<!doctype html>
<html lang="en" data-theme="purple">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LiveStats — Roster</title>
<style>
  :root{
    --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --bg:#0b0f1a; --panel:#0f1422; --panel-2:#12182a;
    --brand:#6d28d9; --brand-2:#a855f7; --shadow: rgba(75,0,130,.35); --ok:#10b981; --bad:#ef4444;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
    background: radial-gradient(1200px 500px at 0% 0%, rgba(168,85,247,.12), transparent 60%),
                radial-gradient(800px 400px at 100% 0%, rgba(109,40,217,.10), transparent 55%),
                linear-gradient(180deg, #0b0f1a, #0b0f1a 60%);
  }
  .app{ max-width:1200px; margin:0 auto; padding:16px; min-height:100vh; display:flex; flex-direction:column; gap:16px }

  header.app-head{
    background: linear-gradient(135deg,var(--brand),var(--brand-2));
    border-radius:18px; padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
    box-shadow: 0 18px 45px var(--shadow);
  }
  .brand{ display:flex; align-items:center; gap:12px }
  .brand img{ height:32px; width:auto; display:block }
  .brand h1{ margin:0; font-size:1.05rem; letter-spacing:.02em }
  .brand p{ margin:.25rem 0 0; font-size:.8rem; opacity:.9 }
  .meta{ text-align:right; font-size:.8rem }
  .badge{ display:inline-flex; gap:8px; align-items:center; padding:4px 10px; border-radius:999px;
          border:1px solid rgba(248,250,252,.25); background: rgba(2,6,23,.25); font-size:.72rem }

  .panel{ background: linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--line);
          border-radius:16px; box-shadow: 0 18px 40px rgba(0,0,0,.4); }
  .panel .inner{ padding:14px }

  .controls{ display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center; margin-bottom:10px }
  .controls .field{ display:flex; align-items:center; gap:8px }
  .controls input[type="search"],
  .controls select{
    background:#0b1220; color:var(--ink); border:1px solid #263145; border-radius:10px; padding:8px 10px; font-size:.95rem;
  }
  .controls button{
    border:1px solid #2e2e3a; background:#0b1220; color:var(--ink); padding:8px 12px; border-radius:10px;
    cursor:pointer; font-weight:600;
  }
  .controls button.primary{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); border:0 }
  .controls .hint{ color: var(--muted); font-size:.85rem }

  .table-wrap{ border:1px solid var(--line); border-radius:14px; overflow:auto; }
  table{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px }
  thead th{
    position:sticky; top:0; background:#0f1526; color:#cbd5e1; text-align:left; padding:10px 12px; font-size:.85rem;
    border-bottom:1px solid #1f2937; letter-spacing:.06em; text-transform:uppercase; white-space:nowrap;
  }
  tbody td{ padding:10px 12px; border-bottom:1px solid #121725; font-size:.95rem; color:#e5e7eb }
  tbody tr:hover{ background:rgba(109,40,217,.08) }
  .num{ text-align:right }
  .muted{ color:var(--muted) }
  .empty{ text-align:center; padding:22px; color:var(--muted) }

  .progress{ height:3px; border-radius:999px; overflow:hidden; background:#111827; }
  .progress > i{ display:block; width:45%; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2));
                 animation: load 1.1s linear infinite }
  @keyframes load{ from{ transform:translateX(-100%) } to{ transform:translateX(220%) } }

  .pill{ display:inline-flex; padding:2px 8px; border-radius:999px; border:1px solid #263145; background:#0b1220; font-size:.8rem }
  .right{ margin-left:auto }
  .sr{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
</style>
</head>
<body>
  <div class="app">
    <header class="app-head">
      <div class="brand">
        <img src="https://thesouthernpullers.com/wp-content/uploads/2025/04/logo.png" alt="SPA logo">
        <div>
          <h1>LiveStats — Roster</h1>
          <p>Google Sheets CSV → dynamic roster (no tabs)</p>
        </div>
      </div>
      <div class="meta">
        <div class="badge">Public CSV source • Ready for API later</div>
        <div style="margin-top:6px">Last loaded: <strong id="loaded-ago">—</strong></div>
      </div>
    </header>

    <div id="progress" class="progress" hidden><i></i></div>

    <section class="panel">
      <div class="inner">
        <div class="controls">
          <div class="field" style="flex:1 1 260px">
            <label for="q" class="sr">Search</label>
            <input id="q" type="search" placeholder="Search driver • vehicle • class • # • notes…" autocomplete="off" />
          </div>

          <div class="field">
            <label class="sr" for="classFilter">Class</label>
            <select id="classFilter">
              <option value="">All classes</option>
            </select>
          </div>

          <div class="field">
            <button id="refresh" title="Reload CSV" class="primary">Reload</button>
          </div>

          <span class="right hint">Click a header to sort • Shift+Click for multi-sort</span>
        </div>

        <div class="table-wrap" id="tableWrap">
          <table id="roster">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="empty" class="empty" hidden>No rows match your filters.</div>

        <div style="display:flex; align-items:center; gap:10px; margin-top:10px; color:var(--muted); font-size:.9rem">
          <span>Total rows: <strong id="rowCount">0</strong></span>
          <span>•</span>
          <button id="downloadCsv">Download current view (CSV)</button>
        </div>
      </div>
    </section>

    <footer class="muted" style="font-size:.82rem">
      © <span id="year"></span> Georgia Motorsports Media • LiveStats Engine
    </footer>
  </div>

<script>
/* ========================== CONFIG ========================== */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEPtdntSso-1gltfBl2drK-E9osbPWo1A3L3sc5q7Uy4QnSMFgUpRBVnLcoGEVVYjZvxByozTuJTGx/pub?gid=1211391611&single=true&output=csv";

/* ============== Utilities ============== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const prog = $('#progress');
const loadedAgo = $('#loaded-ago');
let loadStart = Date.now();
let tickTimer;

function showProgress(on){ prog.hidden = !on }
function startTicker(){
  clearInterval(tickTimer);
  tickTimer = setInterval(()=>{
    const s = Math.floor((Date.now()-loadStart)/1000);
    const m = Math.floor(s/60), r = s%60;
    loadedAgo.textContent = (m? (m+'m '):'') + r + 's ago';
  },1000);
}

/* Robust CSV parser (handles quotes, commas, newlines in quotes) */
function parseCSV(text){
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for(let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if(inQuotes){
      if(c === '"' && n === '"'){ cur+='"'; i++; }
      else if(c === '"'){ inQuotes = false; }
      else { cur += c; }
    }else{
      if(c === '"'){ inQuotes = true; }
      else if(c === ','){ row.push(cur); cur=''; }
      else if(c === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else if(c === '\r'){ /* ignore */ }
      else { cur += c; }
    }
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function toCSV(rows){
  return rows.map(r=> r.map(c=>{
    const s = String(c??'');
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')).join('\n');
}

/* ============== State ============== */
let headers = [];
let rawRows = [];     // from CSV
let viewRows = [];    // filtered/sorted
let sortState = [];   // [{key, dir}...]

/* ============== Rendering ============== */
function renderTable(){
  const thead = $('#thead'), tbody = $('#tbody');
  // Head
  thead.innerHTML = `<tr>${headers.map((h,i)=>{
    const s = sortState.find(x=>x.key===i);
    const arrow = s ? (s.dir>0?'↑':'↓') : '';
    const n = s ? ` <span class="muted">(${sortState.indexOf(s)+1})</span>` : '';
    return `<th data-col="${i}" role="button" tabindex="0">${h} ${arrow}${n}</th>`;
  }).join('')}</tr>`;

  // Body
  if(!viewRows.length){
    $('#empty').hidden = false;
    tbody.innerHTML = '';
  }else{
    $('#empty').hidden = true;
    tbody.innerHTML = viewRows.map(r=>{
      return `<tr>${r.map((c,idx)=>{
        const num = /^[\d,.]+$/.test(c) && !isNaN(Number(c.replace(/,/g,'')));
        return `<td class="${num?'num':''}">${c}</td>`;
      }).join('')}</tr>`;
    }).join('');
  }
  $('#rowCount').textContent = viewRows.length;

  // Bind header sorting
  $$('#thead th').forEach(th=>{
    th.onclick = e => { onHeaderSort(Number(th.dataset.col), e.shiftKey); };
    th.onkeydown = e => { if(e.key==='Enter' || e.key===' '){ onHeaderSort(Number(th.dataset.col), e.shiftKey); e.preventDefault(); } };
  });

  // Populate class filter once (if a "Class" column exists)
  const classIdx = headers.findIndex(h => /class/i.test(h));
  if(classIdx >= 0){
    const sel = $('#classFilter');
    if(sel.options.length <= 1){ // initial fill
      const classes = Array.from(new Set(rawRows.map(r=>r[classIdx]).filter(Boolean))).sort();
      for(const c of classes){
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        sel.appendChild(o);
      }
    }
  }
}

function onHeaderSort(col, multi){
  let next = [...sortState];
  const existing = next.find(s=>s.key===col);
  if(!multi) next = existing ? [{key:col, dir: -existing.dir}] : [{key:col, dir:1}];
  else{
    if(existing){ existing.dir = -existing.dir; }
    else next.push({key:col, dir:1});
  }
  sortState = next;
  applyFilters();
}

/* ============== Filters & Sorting ============== */
function applyFilters(){
  const q = $('#q').value.trim().toLowerCase();
  const cFilter = $('#classFilter').value;

  // Filter
  let rows = rawRows.filter(r=>{
    const hitClass = !cFilter || r.some((v,idx)=> /class/i.test(headers[idx]) && String(v)===cFilter);
    if(!q) return hitClass;
    const hitText = r.some(v=> String(v).toLowerCase().includes(q));
    return hitClass && hitText;
  });

  // Sort
  if(sortState.length){
    rows.sort((a,b)=>{
      for(const {key,dir} of sortState){
        const A = a[key] ?? '', B = b[key] ?? '';
        const nA = Number(String(A).replace(/,/g,'')), nB = Number(String(B).replace(/,/g,''));
        const bothNum = !isNaN(nA) && !isNaN(nB);
        const cmp = bothNum ? (nA - nB) : String(A).localeCompare(String(B), undefined, {numeric:true,sensitivity:'base'});
        if(cmp !== 0) return dir * cmp;
      }
      return 0;
    });
  }

  viewRows = rows;
  renderTable();
}

/* ============== Loading ============== */
async function loadCSV(){
  showProgress(true);
  loadStart = Date.now();
  try{
    const res = await fetch(CSV_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();

    const rows = parseCSV(text).filter(r => r.some(c=>String(c).trim().length));
    headers = rows.shift() || [];
    rawRows = rows.map(r => headers.map((_,i)=> r[i] ?? ''));

    // Heuristic cleanup: trim cells, normalize spaces
    rawRows = rawRows.map(r=> r.map(c=> String(c).replace(/\s+/g,' ').trim()) );

    // Initial sort hint: if there’s a “#” column or “Order/Lineup” use it
    const orderIdx =
      headers.findIndex(h=> /^(\#|order|position|lineup)$/i.test(h)) >= 0
        ? headers.findIndex(h=> /^(\#|order|position|lineup)$/i.test(h))
        : -1;

    sortState = orderIdx >= 0 ? [{key:orderIdx, dir:1}] : [];

    applyFilters();
    startTicker();
  }catch(err){
    console.error(err);
    $('#tbody').innerHTML = '';
    $('#thead').innerHTML = '';
    $('#empty').hidden = false;
    $('#empty').textContent = 'Failed to load CSV ('+(err.message||'error')+').';
  }finally{
    showProgress(false);
  }
}

/* ============== Download current view as CSV ============== */
function downloadCurrentCSV(){
  const rows = [headers, ...viewRows];
  const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'roster_view.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ============== Events ============== */
$('#refresh').addEventListener('click', loadCSV);
$('#q').addEventListener('input', applyFilters);
$('#classFilter').addEventListener('change', applyFilters);
$('#downloadCsv').addEventListener('click', downloadCurrentCSV);

/* Init */
document.getElementById('year').textContent = new Date().getFullYear();
loadCSV();
</script>
</body>
</html>
